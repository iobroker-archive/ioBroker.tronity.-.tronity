{
  "version": 3,
  "sources": ["../src/main.ts"],
  "sourcesContent": ["import * as utils from '@iobroker/adapter-core';\nimport got from 'got';\nimport * as cache from 'memory-cache';\n\nclass Tronity extends utils.Adapter {\n\tprivate timeout: any = null;\n\tprivate URL = 'https://api.tronity.tech';\n\n\tpublic constructor(options: Partial<utils.AdapterOptions> = {}) {\n\t\tsuper({\n\t\t\t...options,\n\t\t\tname: 'tronity',\n\t\t});\n\t\tthis.on('ready', this.onReady.bind(this));\n\t\tthis.on('stateChange', this.onStateChange.bind(this));\n\t\tthis.on('message', this.onMessage.bind(this));\n\t\tthis.on('unload', this.onUnload.bind(this));\n\t}\n\n\tprivate async onReady(): Promise<void> {\n\t\tthis.log.debug('Starting');\n\t\tthis.subscribeStates('command.*');\n\t\tawait this.setStateAsync('info.connection', false, true);\n\t\tif (this.config.client_id && this.config.client_secret && this.config.vehicle_id) {\n\t\t\tawait this.setStateAsync('info.connection', true, true);\n\t\t\tawait this.initSetObject('command.Charging', 'boolean', 'switch');\n\t\t\tawait this.initSetObject('odometer', 'number', 'level');\n\t\t\tawait this.initSetObject('range', 'number', 'level');\n\t\t\tawait this.initSetObject('level', 'number', 'level');\n\t\t\tawait this.initSetObject('charging', 'string', 'text');\n\t\t\tawait this.initSetObject('power', 'number', 'level');\n\t\t\tawait this.initSetObject('chargeRemainingTime', 'number', 'value.time');\n\t\t\tawait this.initSetObject('plugged', 'boolean', 'switch');\n\t\t\tawait this.initSetObject('chargerPower', 'number', 'level');\n\t\t\tawait this.initSetObject('latitude', 'number', 'value.gps.longitude');\n\t\t\tawait this.initSetObject('longitude', 'number', 'value.gps.latitude');\n\t\t\tawait this.initSetObject('timestamp', 'number', 'value.time');\n\t\t\tawait this.initSetObject('lastUpdate', 'number', 'value.time');\n\n\t\t\tawait this.setStateAsync('info.connection', true, true);\n\t\t\tawait this.setStateAsync('command.Charging', false);\n\t\t\tawait this.updateVehicleData();\n\t\t}\n\t}\n\n\tprivate async initSetObject(name: string, type: any, role: string): Promise<any> {\n\t\treturn this.setObjectNotExistsAsync(name, {\n\t\t\ttype: 'state',\n\t\t\tcommon: {\n\t\t\t\tname,\n\t\t\t\ttype,\n\t\t\t\trole,\n\t\t\t\twrite: true,\n\t\t\t\tread: true,\n\t\t\t},\n\t\t\tnative: {},\n\t\t});\n\t}\n\n\tprivate async getToken(): Promise<string> {\n\t\ttry {\n\t\t\tif (cache.get(this.config.client_id)) {\n\t\t\t\treturn cache.get(this.config.client_id);\n\t\t\t}\n\t\t\tconst token = (await got\n\t\t\t\t.post(`${this.URL}/authentication`, {\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tclient_id: this.config.client_id,\n\t\t\t\t\t\tclient_secret: this.config.client_secret,\n\t\t\t\t\t\tgrant_type: 'app',\n\t\t\t\t\t},\n\t\t\t\t})\n\t\t\t\t.json()) as {\n\t\t\t\taccess_token: string;\n\t\t\t\texpires_in: number;\n\t\t\t};\n\t\t\tcache.put(this.config.client_id, token.access_token, token.expires_in - 120);\n\t\t\treturn token.access_token;\n\t\t} catch (e: any) {\n\t\t\tthis.log.error(e);\n\t\t\tthrow Error(e);\n\t\t}\n\t}\n\n\tprivate async updateVehicleData(): Promise<void> {\n\t\ttry {\n\t\t\tif (this.config.vehicle_id) {\n\t\t\t\tconst token = await this.getToken();\n\t\t\t\tconst status = (await got\n\t\t\t\t\t.get(`${this.URL}/tronity/vehicles/${this.config.vehicle_id}/last_record`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.json()) as {\n\t\t\t\t\todometer: number;\n\t\t\t\t\trange: number;\n\t\t\t\t\tlevel: number;\n\t\t\t\t\tcharging: string;\n\t\t\t\t\tchargeRemainingTime: number;\n\t\t\t\t\tplugged: boolean;\n\t\t\t\t\tchargerPower: number;\n\t\t\t\t\tlatitude: number;\n\t\t\t\t\tlongitude: number;\n\t\t\t\t\ttimestamp: number;\n\t\t\t\t\tlastUpdate: number;\n\t\t\t\t};\n\t\t\t\tif (status.odometer > -1) this.setState('odometer', status.odometer, true);\n\t\t\t\tif (status.range > -1) this.setState('range', status.range, true);\n\t\t\t\tif (status.level > -1) this.setState('level', status.level, true);\n\t\t\t\tif (status.charging && status.charging.length > 0) this.setState('charging', status.charging, true);\n\t\t\t\tif (status.chargeRemainingTime > 0)\n\t\t\t\t\tthis.setState('chargeRemainingTime', status.chargeRemainingTime, true);\n\t\t\t\tif (status.plugged !== null) this.setState('plugged', status.plugged, true);\n\t\t\t\tif (status.chargerPower > 0) this.setState('chargerPower', status.chargerPower, true);\n\t\t\t\tif (status.latitude !== null) this.setState('latitude', status.latitude, true);\n\t\t\t\tif (status.longitude !== null) this.setState('longitude', status.longitude, true);\n\t\t\t\tif (status.timestamp)\n\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t'timestamp',\n\t\t\t\t\t\ttypeof status.timestamp === 'number' ? status.timestamp : new Date(status.timestamp).getTime(),\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t);\n\t\t\t\tif (status.lastUpdate)\n\t\t\t\t\tthis.setState(\n\t\t\t\t\t\t'lastUpdate',\n\t\t\t\t\t\ttypeof status.lastUpdate === 'number'\n\t\t\t\t\t\t\t? status.lastUpdate\n\t\t\t\t\t\t\t: new Date(status.lastUpdate).getTime(),\n\t\t\t\t\t\ttrue,\n\t\t\t\t\t);\n\t\t\t}\n\t\t} catch (e: any) {\n\t\t\tthis.log.error(e);\n\t\t}\n\t\tthis.timeout = setTimeout(() => this.updateVehicleData(), 60 * 1000);\n\t}\n\n\tprivate async onMessage(msg: any): Promise<void> {\n\t\tif (msg.command === 'validate') {\n\t\t\tconst client_id = msg.message.client_id;\n\t\t\tconst client_secret = msg.message.client_secret;\n\n\t\t\tthis.log.info('Try to validate login data and get vehicles');\n\t\t\ttry {\n\t\t\t\tconst token = (await got\n\t\t\t\t\t.post(`${this.URL}/authentication`, {\n\t\t\t\t\t\tjson: {\n\t\t\t\t\t\t\tclient_id,\n\t\t\t\t\t\t\tclient_secret,\n\t\t\t\t\t\t\tgrant_type: 'app',\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.json()) as {\n\t\t\t\t\taccess_token: string;\n\t\t\t\t\texpires_in: number;\n\t\t\t\t};\n\t\t\t\tconst vehicles = (await got\n\t\t\t\t\t.get(`${this.URL}/tronity/vehicles?limit=1000`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${token.access_token}`,\n\t\t\t\t\t\t},\n\t\t\t\t\t})\n\t\t\t\t\t.json()) as {\n\t\t\t\t\tdata: [];\n\t\t\t\t};\n\t\t\t\tthis.sendTo(msg.from, msg.command, { success: true, vehicles: vehicles.data }, msg.callback);\n\t\t\t} catch (e: any) {\n\t\t\t\tthis.log.error(e);\n\t\t\t\tthis.sendTo(msg.from, msg.command, { success: false }, msg.callback);\n\t\t\t}\n\t\t}\n\t}\n\n\tprivate onUnload(callback: () => void): void {\n\t\ttry {\n\t\t\tif (this.timeout) clearTimeout(this.timeout);\n\t\t\tcallback();\n\t\t} catch (e) {\n\t\t\tcallback();\n\t\t}\n\t}\n\n\tprivate async onStateChange(id: string, state: ioBroker.State | null | undefined): Promise<void> {\n\t\tif (!state) return;\n\t\tthis.log.debug(`State Change: ${id} to ${state.val} ack ${state.ack}`);\n\n\t\tif (this.config.vehicle_id && state.ack === false) {\n\t\t\tconst currentId = id.substring(this.namespace.length + 1);\n\t\t\tswitch (currentId) {\n\t\t\t\tcase 'command.Charging':\n\t\t\t\t\tif (state.val) {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst token = await this.getToken();\n\t\t\t\t\t\t\tawait got.post(\n\t\t\t\t\t\t\t\t`${this.URL}/tronity/vehicles/${this.config.vehicle_id}/control/start_charging`,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tthis.log.info('Try to start charging!');\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\tthis.log.error(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t} else {\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\tconst token = await this.getToken();\n\t\t\t\t\t\t\tawait got.post(\n\t\t\t\t\t\t\t\t`${this.URL}/tronity/vehicles/${this.config.vehicle_id}/control/stop_charging`,\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\t\t\t\tAuthorization: `Bearer ${token}`,\n\t\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t\t},\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tthis.log.info('Try to stop charging!');\n\t\t\t\t\t\t} catch (e: any) {\n\t\t\t\t\t\t\tthis.log.error(e);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n}\n\nif (require.main !== module) {\n\tmodule.exports = (options: Partial<utils.AdapterOptions> | undefined) => new Tronity(options);\n} else {\n\t(() => new Tronity())();\n}\n"],
  "mappings": "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",
  "names": ["got"]
}
